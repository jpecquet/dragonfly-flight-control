# Postprocessing Scripts

Python tools for visualizing dragonfly simulation output.

## Requirements

```bash
# From repository root:
pip install -r requirements.txt

# For hybrid renderer (default):
brew install blender  # macOS, or download from blender.org

# For animations:
brew install ffmpeg  # macOS

# Optional: lock current environment exactly
pip freeze > requirements.lock.txt
```

## Rendering Backend

### Hybrid (Default and only backend)

Uses Blender for high-quality 3D mesh rendering combined with matplotlib for axes, trajectories, and annotations. Produces consistent visual style matching 2D plots (Times New Roman, STIX fonts).

```bash
python -m post.plot_simulation output.h5 output.mp4  # Uses hybrid by default
```

Requirements:
- Blender 3.x or 4.x (system install)
- Pillow (for PNG compositing)
- ffmpeg (for video assembly)

If Blender is not available, falls back to matplotlib-only rendering (axes, trajectories, forces, and simplified body/wing models).

## Assets

Wing meshes must be placed in `assets/` directory:

```
assets/
├── forewing.obj    # Forewing mesh (modeled as right wing)
└── hindwing.obj    # Hindwing mesh (modeled as right wing)
```

Mesh convention (Blender export with forward=X, up=Z):
- +X along chord (leading to trailing edge)
- -Y along span (root to tip)
- +Z normal (dorsal)

Left wings are generated by mirroring the Y coordinate.

## Scripts

### plot_simulation.py

Visualize simulation output (body + wings + force vectors).

```bash
# Animation with hybrid renderer (default)
python -m post.plot_simulation output.h5 output.mp4

# Skip frames to speed up rendering (use every 3rd frame)
python -m post.plot_simulation output.h5 output.mp4 --frame-step 3

# With custom configuration
python -m post.plot_simulation output.h5 output.mp4 --config my_config.json

# Force matplotlib-only fallback (skip Blender)
python -m post.plot_simulation output.h5 output.mp4 --no-blender
```

### plot_tracking.py

Visualize trajectory tracking simulation (includes target trajectory and error).

```bash
# Animation + summary plot
python -m post.plot_tracking track.h5 tracking.mp4

# Skip frames in animation render
python -m post.plot_tracking track.h5 tracking.mp4 --frame-step 3

# Summary plot only
python -m post.plot_tracking track.h5 tracking.png

# Force matplotlib-only fallback (skip Blender)
python -m post.plot_tracking track.h5 tracking.mp4 --no-blender
```

### plot_landscape.py

Plot optimizer objective function landscape (1D or 2D).

```bash
python -m post.plot_landscape optim_landscape.h5 landscape.png
```

### plot_wing_rotation.py

Animate wing basis vectors through rotation phases.

```bash
python -m post.plot_wing_rotation wingtest.h5 rotation.mp4
```

### plot_stick.py

Visualize wing stroke motion projected onto a sphere (equirectangular projection).

```bash
# Animate a specific wing
python -m post.plot_stick output.h5 fore_left stroke.mp4

# List available wings
python -m post.plot_stick output.h5
```

### plot_terminal_velocity.py

Visualize terminal velocity simulation results.

```bash
# Static plot
python -m post.plot_terminal_velocity --psi 45 output.png

# Animation
python -m post.plot_terminal_velocity --psi 45 output.mp4
```

## Custom Configuration

The hybrid renderer accepts a JSON configuration file:

```json
{
  "camera": {
    "elevation": 30.0,
    "azimuth": -60.0,
    "ortho_scale": 3.0,
    "figsize_width": 6.0,
    "figsize_height": 4.0,
    "dpi": 300
  },
  "style": {
    "font_family": "serif",
    "font_serif": "Times New Roman",
    "trajectory_color": "blue",
    "target_color": "green",
    "error_color": "red"
  },
  "framerate": 30,
  "trail_length": 100,
  "show_forces": true,
  "force_scale": 0.05
}
```

Resolution is computed as `figsize * dpi` (default: 6x4 inches at 300 dpi = 1800x1200 pixels).

## Module Structure

```
post/
├── __init__.py              # Package init, matplotlib config
├── io.py                    # HDF5 readers
├── hybrid_config.py         # Shared camera/style configuration
├── mpl_overlay.py           # Matplotlib 3D overlay rendering
├── composite.py             # PNG compositing + video assembly
├── blender/
│   ├── __init__.py
│   ├── materials.py         # Blender material definitions
│   └── render_dragonfly.py  # Blender headless rendering script
├── plot_simulation.py       # CLI: simulation visualization
├── plot_tracking.py         # CLI: trajectory tracking visualization
├── plot_landscape.py        # CLI: optimizer landscape
├── plot_wing_rotation.py    # CLI: wing rotation animation
├── plot_stick.py            # CLI: wing stroke sphere projection
└── plot_terminal_velocity.py # CLI: terminal velocity visualization
```

## Library Usage

```python
from post.io import read_simulation, read_tracking
from post.hybrid_config import HybridConfig, compute_viewport
from post.composite import render_hybrid

# Read simulation data
params, time, states, wings = read_simulation("output.h5")

# Create custom config
config = HybridConfig()
config.camera.elevation = 45.0
config.viewport = compute_viewport(states)

# Render with hybrid pipeline
render_hybrid(states, wings, params, "output.h5", "output.mp4", config=config)
```
