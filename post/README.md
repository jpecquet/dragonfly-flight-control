# Postprocessing Scripts

Python tools for visualizing dragonfly simulation output.

## Requirements

```bash
# From repository root:
pip install -r requirements.txt

# For hybrid renderer (default):
brew install blender  # macOS, or download from blender.org

# For animations:
brew install ffmpeg  # macOS

# Optional: lock current environment exactly
pip freeze > requirements.lock.txt
```

## Rendering Backend

### Hybrid (Default and only backend)

Uses Blender for high-quality 3D mesh rendering combined with matplotlib for axes, trajectories, and annotations. Produces consistent visual style matching 2D plots (Times New Roman, STIX fonts).

```bash
python -m post.plot_simulation output.h5 output.mp4  # Uses hybrid by default
```

Requirements:
- Blender 3.x or 4.x (system install)
- Pillow (for PNG compositing)
- ffmpeg (for video assembly)

If Blender is not available, falls back to matplotlib-only rendering (axes, trajectories, forces, and simplified body/wing models).

## Assets

Wing meshes must be placed in `assets/` directory:

```
assets/
├── forewing.obj    # Forewing mesh (modeled as right wing)
└── hindwing.obj    # Hindwing mesh (modeled as right wing)
```

Mesh convention (Blender export with forward=X, up=Z):
- +X along chord (leading to trailing edge)
- -Y along span (root to tip)
- +Z normal (dorsal)

Left wings are generated by mirroring the Y coordinate.

## Scripts

### plot_simulation.py

Visualize simulation output (body + wings + force vectors).

```bash
# Animation with hybrid renderer (default)
python -m post.plot_simulation output.h5 output.mp4

# Skip frames to speed up rendering (use every 3rd frame)
python -m post.plot_simulation output.h5 output.mp4 --frame-step 3

# With custom configuration
python -m post.plot_simulation output.h5 output.mp4 --config my_config.json

# Force matplotlib-only fallback (skip Blender)
python -m post.plot_simulation output.h5 output.mp4 --no-blender

# Use dark theme
python -m post.plot_simulation output.h5 output.mp4 --theme dark
```

### plot_tracking.py

Visualize trajectory tracking simulation (includes target trajectory and error).

```bash
# Animation + summary plot
python -m post.plot_tracking track.h5 tracking.mp4

# Skip frames in animation render
python -m post.plot_tracking track.h5 tracking.mp4 --frame-step 3

# Summary plot only
python -m post.plot_tracking track.h5 tracking.png

# Force matplotlib-only fallback (skip Blender)
python -m post.plot_tracking track.h5 tracking.mp4 --no-blender

# Dark theme for animation + summary
python -m post.plot_tracking track.h5 tracking.mp4 --theme dark
```

### plot_landscape.py

Plot optimizer objective function landscape (1D or 2D).

```bash
python -m post.plot_landscape optim_landscape.h5 landscape.png
python -m post.plot_landscape optim_landscape.h5 landscape_dark.png --theme dark
```

### plot_wing_rotation.py

Animate wing basis vectors through rotation phases.

```bash
python -m post.plot_wing_rotation wingtest.h5 rotation.mp4
python -m post.plot_wing_rotation wingtest.h5 rotation_dark.mp4 --theme dark
```

### plot_stick.py

Visualize right fore/hind wing stick motion in the nondimensional `(X,Z)` plane.

```bash
# Animate right fore/hind sticks
python -m post.plot_stick output.h5 stroke.mp4

# Use a custom span station (default is 2/3)
python -m post.plot_stick output.h5 stroke_s25.mp4 --station 0.25

# List available wings and usage
python -m post.plot_stick output.h5

# Dark theme
python -m post.plot_stick output.h5 stroke_dark.mp4 --theme dark
```

### plot_terminal_velocity.py

Visualize terminal velocity simulation results.

```bash
# Static plot
python -m post.plot_terminal_velocity --psi 45 output.png

# Animation
python -m post.plot_terminal_velocity --psi 45 output.mp4

# Dark theme
python -m post.plot_terminal_velocity --psi 45 --theme dark output.mp4
```

### plot_force_comparison.py

Compare one or more vertical force time series from simulation outputs.

```bash
python -m post.plot_force_comparison runs/wang2007/demo/post/force_comparison.png --omega-nondim 14.982242894657686 --series runs/wang2007/demo/sim/output_7harm.h5 "Run A" --series runs/wang2007/demo/sim/output_1harm.h5 "Run B"
python -m post.plot_force_comparison runs/wang2007/demo/post/force_comparison.dark.png --omega-nondim 14.982242894657686 --series runs/wang2007/demo/sim/output_7harm.h5 "Run A" --series runs/wang2007/demo/sim/output_1harm.h5 "Run B" --theme dark
python -m post.plot_force_comparison runs/wang2007/demo/post/force_plus_cfd.png --omega-nondim 14.982242894657686 --series runs/wang2007/demo/sim/output_7harm.h5 "7 harmonics/wingbeat (35 components)" --series runs/wang2007/demo/sim/output_1harm.h5 "1 harmonic" --series-csv data/kinematics/wang2007/cfd_data.csv t Fz "CFD"
```

## Custom Configuration

The hybrid renderer accepts a JSON configuration file:

```json
{
  "camera": {
    "elevation": 30.0,
    "azimuth": -60.0,
    "ortho_scale": 3.0,
    "figsize_width": 6.5,
    "figsize_height": 4.333333333333333,
    "dpi": 300
  },
  "style": {
    "theme": "dark",
    "font_family": "serif",
    "font_serif": "Times New Roman",
    "trajectory_color": "#4aa3ff",
    "target_color": "#56d68b",
    "error_color": "#ff6b6b",
    "figure_facecolor": "#101418",
    "axes_facecolor": "#101418"
  },
  "framerate": 30,
  "trail_length": 100,
  "show_forces": false,
  "force_scale": 0.05
}
```

Resolution is computed as `figsize * dpi` (default: 6.5x4.3333 inches at 300 dpi = 1950x1300 pixels).

Most matplotlib plot scripts use a shared default width parameter in `post/style.py`:
`DEFAULT_FIGURE_WIDTH_IN = 6.5`. Update this value to retune plot widths globally.

## Module Structure

```
post/
├── __init__.py              # Package init, matplotlib config
├── io.py                    # HDF5 readers
├── hybrid_config.py         # Shared camera/style configuration
├── mpl_overlay.py           # Matplotlib 3D overlay rendering
├── composite.py             # PNG compositing + video assembly
├── blender/
│   ├── __init__.py
│   ├── materials.py         # Blender material definitions
│   └── render_dragonfly.py  # Blender headless rendering script
├── plot_simulation.py       # CLI: simulation visualization
├── plot_tracking.py         # CLI: trajectory tracking visualization
├── plot_landscape.py        # CLI: optimizer landscape
├── plot_wing_rotation.py    # CLI: wing rotation animation
├── plot_stick.py            # CLI: right fore/hind stick animation in (X,Z)
├── plot_terminal_velocity.py # CLI: terminal velocity visualization
├── plot_force_comparison.py # CLI: compare vertical force time series
└── time_series.py           # Shared static time-series plotting template
```

## Library Usage

```python
from post.io import read_simulation, read_tracking
from post.hybrid_config import HybridConfig, compute_viewport
from post.composite import render_hybrid

# Read simulation data
params, time, states, wings = read_simulation("output.h5")

# Create custom config
config = HybridConfig()
config.camera.elevation = 45.0
config.viewport = compute_viewport(states)

# Render with hybrid pipeline
render_hybrid(states, wings, params, "output.h5", "output.mp4", config=config)
```
